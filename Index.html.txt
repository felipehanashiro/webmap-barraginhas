<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webmap - Projeto Barraginhas</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Define a altura do mapa */
        #map { height: 100vh; }

        /* Estilo personalizado para os pop-ups do Leaflet */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }
        .leaflet-popup-content strong {
            color: #333;
            margin-right: 5px;
        }
        
        /* Caixa de erro da API */
        .api-error-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 15px 20px;
            border: 2px solid #D9534F;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-family: Arial, sans-serif;
            max-width: 400px;
        }
        .api-error-box h3 {
            color: #D9534F;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 0;
        }
        .api-error-box p {
            margin-bottom: 10px;
        }
        .api-error-box code {
            background-color: #f0f0f0;
            padding: 2px 5px;
            border-radius: 4px;
            color: #c7254e;
        }

    </style>
</head>
<body class="font-sans">

    <!-- PAINEL DE TÍTULO E CONTADOR -->
    <div id="title-card" class="absolute top-4 left-4 z-[1000] p-4 bg-white bg-opacity-90 shadow-lg rounded-lg max-w-xs md:max-w-sm">
        <h4 class="text-xl font-semibold text-gray-800 m-0 mb-1">Projeto Barraginhas</h4>
        <p class="text-xs text-gray-600 m-0 mb-2 leading-tight">EMATER-RIO, SEDIPAF, GOVERNO DO ESTADO DO RIO DE JANEIRO</p>
        <h5 class="text-base font-semibold text-gray-800 m-0">Total de Barraginhas: 
            <span id="total-counter" class="text-blue-600 text-lg font-bold">0</span>
        </h5>
    </div>

    <div id="map"></div>

    <script>
        // ====================================================================
        // CONFIGURAÇÃO DA API SUPABASE (ATENÇÃO AQUI!)
        // ====================================================================

        // 1. Cole a sua URL do Supabase aqui (Encontre em Project Settings > API > Project URL)
        const SUPABASE_URL = 'https://ooucatlowyexiuscophb.supabase.co';

        // 2. Cole a sua chave 'anon' (pública) aqui (Encontre em Project Settings > API > Project API Keys)
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vdWNhdGxvd3lleGl1c2NvcGhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMTA3ODUsImV4cCI6MjA3NzY4Njc4NX0.tVOomCoeorIU0tpmtt1LhDpg2SOAFACnwbF3qouEsxs'; // ATENÇÃO: Cole sua chave 'anon' aqui

        // ====================================================================
        // INICIALIZAÇÃO DO CLIENTE SUPABASE
        // ====================================================================
        let supabaseClient;
        let apiKeyValid = false;
        
        if (SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'COLE_AQUI_SUA_CHAVE_ANON_KEY' && SUPABASE_URL) {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                apiKeyValid = true;
                console.log("Cliente Supabase inicializado com sucesso.");
            } catch (e) {
                console.error("Erro ao inicializar o cliente Supabase:", e);
                showApiError();
            }
        } else {
            console.error("Chave de API ou URL do Supabase não definida.");
            showApiError();
        }

        // ====================================================================
        // INICIALIZAÇÃO DO MAPA (LEAFLET)
        // ====================================================================

        // Coordenadas centrais (aproximadamente Rio de Janeiro)
        const mapCenter = [-21.43, -41.68];

        // Inicializa o mapa
        const map = L.map('map').setView(mapCenter, 9);

        // Camadas de Mapa Base
        const streetsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });

        // Adiciona a camada de ruas como padrão
        streetsLayer.addTo(map);

        // Objeto de Mapas Base para o controle
        const baseMaps = {
            "Mapa Básico": streetsLayer,
            "Satélite": satelliteLayer,
            "Topografia": topoLayer
        };

        // Objeto para as Camadas de Sobreposição (Overlay)
        const overlayMaps = {};
        
        // Adiciona o controle de camadas
        const layerControl = L.control.layers(baseMaps, overlayMaps, { 
            position: 'topright',
            collapsed: false 
        }).addTo(map);

        // ====================================================================
        // FUNÇÕES DE CARREGAMENTO DE DADOS (SUPABASE)
        // ====================================================================

        // 1. Carregar Pontos de Barraginhas
        // --------------------------------------------------------------------
        async function loadBarraginhas() {
            try {
                const { data, error } = await supabaseClient
                    .rpc('get_barraginhas_geojson'); 

                if (error) {
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.warn("Nenhum dado de barraginha foi retornado.");
                    return;
                }

                // ATUALIZA O CONTADOR NO PAINEL DE TÍTULO
                document.getElementById('total-counter').innerText = data.length;
                
                // Extrai o GeoJSON da resposta
                const geojsonData = data.map(item => item.geojson_feature);

                // Cria UMA camada para TODAS as barraginhas, sem filtro
                const barraginhasLayer = L.geoJSON(geojsonData, {
                    // Sem filtro, carrega todos os pontos
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng, {
                            radius: 5,
                            fillColor: "#0078ff", // Azul para todos os pontos
                            color: "#000",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: onEachBarraginha
                });
                
                // Adiciona a camada única ao controle
                layerControl.addOverlay(barraginhasLayer, "Barraginhas");
                
                // Adiciona a camada ao mapa
                barraginhasLayer.addTo(map);

            } catch (error) {
                console.error("Erro ao buscar dados das barraginhas:", error);
            }
        }

        // Função de Pop-up para cada Barraginha
        function onEachBarraginha(feature, layer) {
            if (feature.properties) {
                
                // Formatação da Data (de MM/DD/YYYY para DD/MM/YYYY)
                let dataFormatada = "N/A";
                if (feature.properties.data) {
                    try {
                        const partes = feature.properties.data.split('/');
                        if (partes.length === 3) {
                            // Assumindo formato MM/DD/YYYY
                            dataFormatada = `${partes[1]}/${partes[0]}/${partes[2]}`;
                        }
                    } catch (e) {
                        console.warn("Erro ao formatar data:", feature.properties.data);
                    }
                }

                // Extrai coordenadas
                const coords = feature.geometry.coordinates;
                const longitude = coords[0].toFixed(6);
                const latitude = coords[1].toFixed(6);
                
                const popupContent = `
                    <strong>Localidade:</strong> ${feature.properties.localidade || 'N/A'}<br>
                    <strong>MBH:</strong> ${feature.properties.mbh || 'N/A'}<br>
                    <strong>Município:</strong> ${feature.properties.mun || 'N/A'}<br>
                    <strong>Data:</strong> ${dataFormatada}<br>
                    <strong>Diâmetro (m):</strong> ${feature.properties.diametro_m || 'N/A'}<br>
                    <strong>Profundidade (m):</strong> ${feature.properties.altura_m || 'N/A'}<br>
                    <strong>Volume (m³):</strong> ${feature.properties.volume_m3 || 'N/A'}<br>
                    <strong>Formato:</strong> ${feature.properties.formato || 'N/A'}<br>
                    <strong>Coordenadas:</strong> ${latitude}, ${longitude}
                `;
                layer.bindPopup(popupContent);
            }
        }

        // 2. Carregar Camada de Municípios
        // --------------------------------------------------------------------
        async function loadMunicipios() {
            try {
                const { data, error } = await supabaseClient
                    .rpc('get_municipios_stats'); 

                if (error) {
                    throw error;
                }

                if (!data || data.length === 0) {
                    console.warn("Nenhum dado de município foi retornado.");
                    return;
                }

                const geojsonData = data.map(item => item.geojson_feature);

                const municipiosLayer = L.geoJSON(geojsonData, {
                    style: {
                        color: "#FFC067", // Laranja
                        weight: 2,
                        opacity: 0.7,
                        fillOpacity: 0.1
                    },
                    onEachFeature: onEachMunicipio
                });
                
                layerControl.addOverlay(municipiosLayer, "Municípios");
                municipiosLayer.addTo(map); // Descomente se quiser que carregue por padrão

            } catch (error) {
                console.error("Erro ao buscar dados dos municípios:", error);
            }
        }

        // Função de Pop-up para cada Município
        function onEachMunicipio(feature, layer) {
            if (feature.properties) {
                // CORREÇÃO: Os dados são "planos" (flat), não estão dentro de 'stats'
                // A função SQL que você colou fornece as propriedades diretamente.
                const props = feature.properties || {};
                const popupContent = `
                    <strong><h3>${props.nome_municipio || 'Município'}</h3></strong><br>
                    <strong>Produtores Atendidos:</strong> ${props.num_produtores || 0}<br>
                    <strong>Total de Barraginhas:</strong> ${props.num_barraginhas || 0}<br>
                    <hr style="margin: 5px 0;">
                    <strong>Volume Total (m³):</strong> ${Math.round(props.volume_total) || 0}<br>
                    <strong>Diâmetro Médio (m):</strong> ${Math.round(props.diametro_medio) || 0}<br>
                    <strong>Profundidade Média (m):</strong> ${(props.profundidade_media || 0).toFixed(2)}<br>
                    <strong>Hora/Máquina Média:</strong> ${(props.h_maq_media || 0).toFixed(2)}
                `;
                layer.bindPopup(popupContent);
            }
        }

        // 3. Carregar Camada de Regiões
        // --------------------------------------------------------------------
        async function loadRegioesPolygons() {
            try {
                const { data, error } = await supabaseClient
                    .rpc('get_regioes_stats_geojson');

                if (error) {
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.warn("Nenhum dado de região foi retornado.");
                    return;
                }
                
                const geojsonData = data.map(item => item.geojson_feature);

                const regioesLayer = L.geoJSON(geojsonData, {
                    style: {
                        color: "#6f42c1", // Roxo
                        weight: 3,
                        opacity: 0.8,
                        fillOpacity: 0.1
                    },
                    onEachFeature: onEachRegiao
                });
                
                layerControl.addOverlay(regioesLayer, "Regiões");
                // regioesLayer.addTo(map); // Carrega por padrão

            } catch (error) {
                console.error("Erro ao buscar dados das regiões:", error);
            }
        }
        
        // Função de Pop-up para cada Região
        function onEachRegiao(feature, layer) {
            if (feature.properties) {
                const props = feature.properties;
                const popupContent = `
                    <strong><h3>Região ${props.nome_regiao || ''}</h3></strong><br>
                    <strong>Beneficiários:</strong> ${props.total_beneficiarios || 0}<br>
                    <strong>Barraginhas:</strong> ${props.total_barraginhas || 0}<br>
                    <strong>Volume Total (m³):</strong> ${Math.round(props.volume_total) || 0}
                `;
                layer.bindPopup(popupContent);
            }
        }
        
        // 4. Função de Erro de API
        // --------------------------------------------------------------------
        function showApiError() {
            const errorBox = document.createElement('div');
            errorBox.className = 'api-error-box';
            errorBox.innerHTML = `
                <h3>Erro de Conexão</h3>
                <p>Não foi possível carregar os dados. A sua chave de API (<code>SUPABASE_ANON_KEY</code>) parece estar incorreta ou em falta.</p>
                <p>Por favor, cole a sua chave <code>anon</code> verdadeira (que começa com <code>ey...</code>) do painel do Supabase (Settings > API) na <strong>linha 85</strong> do ficheiro <code>index.html</code>.</p>
            `;
            document.body.appendChild(errorBox);
        }

        // ====================================================================
        // INICIALIZAÇÃO DOS DADOS
        // ====================================================================
        
        if (apiKeyValid) {
            // Se a chave for válida, carrega todos os dados
            loadBarraginhas();
            loadMunicipios();
            loadRegioesPolygons();
        } else {
            // Se a chave for o placeholder, mostra a caixa de erro
            showApiError();
        }
        
    </script>

</body>
</html>





